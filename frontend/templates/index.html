<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMR Integrated - Disease X Smart Alert System</title>
    
    <!-- External Dependencies -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Local Stylesheets -->
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/clinical-decision-support.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico">
</head>
<body>
    <!-- System Header -->
    <header class="system-header">
        <div class="header-content">
            <div class="system-brand">
                <div class="system-logo">
                    <span class="system-logo-text">Pfizer</span>
                </div>
                <div class="brand-divider"></div>
                <div class="system-info">
                    <h1 class="system-name">DiseaseX–DrugA Clinical Advisor</h1>
                    <p class="system-subtitle">An AI-Driven Clinical Decision Support System</p>
                    <p class="system-tagline">for Optimizing Drug A Treatment in Disease X Patients</p>
                </div>
            </div>
            <div class="system-status">
                <div class="status-indicator">
                    <div class="status-dot" id="apiStatusDot"></div>
                    <span id="apiStatusText">System Online</span>
                </div>
                <div class="version-info">
                    <div>Version 2.0.0</div>
                    <div>AI-Powered</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Mobile Navigation Toggle -->
    <button class="mobile-nav-toggle" onclick="toggleMobileSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="emr-container">
        <!-- Sidebar - Patient List -->
        <div class="patient-sidebar" id="patientSidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Patient List</div>
                <input type="text" class="search-box" placeholder="Search patients..." id="patientSearch">
            </div>
            <div class="patient-list" id="patientList">
                <!-- Patient list will be dynamically generated by JavaScript -->
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Top Toolbar -->
            <div class="toolbar">
                <div class="toolbar-left">
                    <div class="patient-header">
                        <div class="patient-name-large" id="currentPatientName">Select a patient to view details</div>
                        <div class="patient-details" id="currentPatientDetails">Click on a patient from the left to start consultation</div>
                    </div>
                </div>
                <div class="toolbar-right">
                    <button class="btn btn-success" onclick="showAddPatientForm()">
                        <i class="fas fa-plus"></i>
                        Add Patient
                    </button>
                    <button class="btn btn-secondary" onclick="refreshPatientData()">
                        <i class="fas fa-sync-alt"></i>
                        Refresh Data
                    </button>
                    <button class="btn btn-primary" onclick="analyzePatient()" id="analyzeBtn">
                        <i class="fas fa-brain"></i>
                        AI Analysis
                    </button>
                </div>
            </div>

            <!-- Smart Alert Panel -->
            <div class="alert-panel hidden" id="alertPanel">
                <div class="alert-header">
                    <div style="flex: 1;">
                <div class="alert-title">
                    <span id="alertPatientName">Drug A Prescription Alert</span>
                </div>
                <div class="alert-subtitle" id="alertPatientDetails">
                    AI-powered clinical decision support for Drug A prescribing
                </div>
                    </div>
                </div>
                
                <div class="alert-content" id="alertContent">
                    <!-- Dynamic content will be inserted here by updateAlertPanelPatientInfo() -->
                </div>
            </div>

            <!-- Clinical Decision Support Components -->
            <div class="clinical-decision-support-container hidden" id="clinicalDecisionSupportContainer">
                <!-- Clinical Eligibility Card will be inserted here -->
                <div id="clinicalEligibilityCardContainer"></div>
                
                <!-- Risk Visualization will be inserted here -->
                <div id="riskVisualizationContainer"></div>
                
                <!-- Decision Support Flow will be inserted here -->
                <div id="decisionSupportFlowContainer"></div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Patient Form (Hidden by default) -->
                <div class="patient-form hidden" id="patientForm">
                    <!-- Multi-step Form -->
                    <div class="step-indicator">
                        <div class="step active" data-step="1">
                            <div class="step-number">1</div>
                            <div class="step-label">Basic Info</div>
                        </div>
                        <div class="step-separator"></div>
                        <div class="step inactive" data-step="2">
                            <div class="step-number">2</div>
                            <div class="step-label">Medical History</div>
                        </div>
                        <div class="step-separator"></div>
                        <div class="step inactive" data-step="3">
                            <div class="step-number">3</div>
                            <div class="step-label">Symptoms</div>
                        </div>
                        <div class="step-separator"></div>
                        <div class="step inactive" data-step="4">
                            <div class="step-number">4</div>
                            <div class="step-label">Review</div>
                        </div>
                    </div>

                    <!-- Step 1: Basic Information -->
                    <div class="form-section" id="step1">
                        <div class="form-section-title">
                            <i class="fas fa-user"></i>
                            Basic Patient Information
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Patient Name *</label>
                                <input type="text" class="form-input" id="patientName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Birth Year *</label>
                                <select class="form-select" id="patientAge" name="patientAge" required>
                                    <option value="">Select Birth Year</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Gender *</label>
                                <select class="form-select" id="patientGender" required>
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Physician ID *</label>
                                <input type="number" class="form-input" id="physicianId" min="1" step="1" placeholder="Enter physician ID number" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Diagnosis Date *</label>
                                <input type="date" class="form-input" id="diagnosisDate" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Symptom Onset Date</label>
                                <input type="date" class="form-input" id="symptomOnsetDate">
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Medical History -->
                    <div class="form-section hidden" id="step2">
                        <div class="form-section-title">
                            <i class="fas fa-history"></i>
                            Medical History & Background
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Location Type *</label>
                                <select class="form-select" id="locationType" required>
                                    <option value="">Select Location</option>
                                    <option value="Hospital">Hospital</option>
                                    <option value="Clinic">Clinic</option>
                                    <option value="Emergency">Emergency Room</option>
                                    <option value="Outpatient">Outpatient</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Insurance Type *</label>
                                <select class="form-select" id="insuranceType" required>
                                    <option value="">Select Insurance</option>
                                    <option value="Private">Private Insurance</option>
                                    <option value="Medicare">Medicare</option>
                                    <option value="Medicaid">Medicaid</option>
                                    <option value="Self-Pay">Self-Pay</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contraindication Level *</label>
                                <select class="form-select" id="contraindicationLevel" required>
                                    <option value="">Select Level</option>
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Additional Notes</label>
                            <textarea class="form-textarea" id="additionalNotes" placeholder="Enter any additional relevant information..."></textarea>
                        </div>
                    </div>

                    <!-- Step 3: Symptoms -->
                    <div class="form-section hidden" id="step3">
                        <div class="form-section-title">
                            <i class="fas fa-stethoscope"></i>
                            Symptoms & Comorbidities
                        </div>
                        <div class="form-group">
                            <label class="form-label">Current Symptoms</label>
                            <div class="form-grid">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Fever"> Fever
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Cough"> Cough
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Fatigue"> Fatigue
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Shortness of Breath"> Shortness of Breath
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Headache"> Headache
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Muscle Pain"> Muscle Pain
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Comorbidities</label>
                            <div class="form-grid">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Diabetes"> Diabetes
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Hypertension"> Hypertension
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Heart Disease"> Heart Disease
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Lung Disease"> Lung Disease
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Kidney Disease"> Kidney Disease
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="Liver Disease"> Liver Disease
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Review -->
                    <div class="form-section hidden" id="step4">
                        <div class="form-section-title">
                            <i class="fas fa-check-circle"></i>
                            Review & Submit
                        </div>
                        <div class="form-group">
                            <p class="text-muted">Please review all the information before submitting. Once submitted, the patient data will be saved and AI analysis will be available.</p>
                        </div>
                        <div id="formReview">
                            <!-- Review content will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="prevBtn" onclick="previousStep()" style="display: none;">
                            <i class="fas fa-arrow-left"></i>
                            Previous
                        </button>
                        <button type="button" class="btn btn-primary" id="nextBtn" onclick="console.log('🖱️ Next button clicked'); nextStep();">
                            Next
                            <i class="fas fa-arrow-right"></i>
                        </button>
                        <button type="button" class="btn btn-success hidden" id="submitBtn" onclick="submitPatientForm()">
                            <i class="fas fa-save"></i>
                            Save Patient
                        </button>
                    </div>
                </div>

                <!-- Default Content -->
                <div id="defaultContent">
                    <div class="text-center p-4">
                        <i class="fas fa-user-md mb-4" style="font-size: 4rem; color: var(--gray-400);"></i>
                        <h2 class="mb-4" style="color: var(--gray-600);">Welcome to EMR Alert System</h2>
                        <p class="text-muted mb-4">Select a patient from the sidebar to view their information and run AI analysis, or add a new patient to get started.</p>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="showAddPatientForm()">
                                <i class="fas fa-plus"></i>
                                Add New Patient
                            </button>
                            <button class="btn btn-secondary" onclick="refreshPatientData()">
                                <i class="fas fa-sync-alt"></i>
                                Refresh Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Processing...</p>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="/static/js/config.js"></script>
    <script src="/static/js/clinical-decision-support.js"></script>
    <script src="/static/js/main.js?v=20251021v4"></script>
    
    <!-- Emergency fallback for showAddPatientForm and navigation functions -->
    <script>
        // Define fallback functions FIRST, before any checks
        console.log('🔧 Defining fallback functions...');
        
        // Fallback navigation functions (defined first)
        function fallbackNextStep() {
            console.log('🔄 fallbackNextStep called');
            let currentStep = window.currentStep || 1;
            const totalSteps = window.totalSteps || 4;
            
            console.log('Current step:', currentStep, 'Total steps:', totalSteps);
            
            if (currentStep < totalSteps) {
                // Validate current step
                if (fallbackValidateCurrentStep(currentStep)) {
                    currentStep++;
                    window.currentStep = currentStep;
                    
                    // Update UI
                    fallbackUpdateStepIndicator(currentStep);
                    fallbackShowStep(currentStep);
                    
                    console.log('✅ Fallback: Moved to step', currentStep);
                } else {
                    alert('Please fill in all required fields before proceeding.');
                }
            } else {
                alert('Already at the last step');
            }
        }
        
        function fallbackPreviousStep() {
            console.log('🔄 fallbackPreviousStep called');
            let currentStep = window.currentStep || 1;
            
            if (currentStep > 1) {
                currentStep--;
                window.currentStep = currentStep;
                
                // Update UI
                fallbackUpdateStepIndicator(currentStep);
                fallbackShowStep(currentStep);
                
                console.log('✅ Fallback: Moved to step', currentStep);
            }
        }
        
        function fallbackValidateCurrentStep(step) {
            console.log('🔍 fallbackValidateCurrentStep called for step:', step);
            const currentStepElement = document.getElementById(`step${step}`);
            
            if (!currentStepElement) {
                console.log('❌ Step element not found:', `step${step}`);
                return false;
            }
            
            // Get all required fields in current step
            const requiredFields = currentStepElement.querySelectorAll('[required]');
            console.log('Found required fields:', requiredFields.length);
            
            for (const field of requiredFields) {
                console.log(`Checking field: ${field.id || field.name || 'unnamed'}, value: "${field.value}"`);
                
                // Special validation for Physician ID
                if (field.id === 'physicianId') {
                    if (!fallbackValidatePhysicianId(field)) {
                        console.log(`❌ Physician ID validation failed`);
                        field.focus();
                        return false;
                    }
                } else {
                    // Standard validation for other fields
                    if (!field.value.trim()) {
                        console.log(`❌ Field "${field.id || field.name || 'unnamed'}" is empty`);
                        field.focus();
                        return false;
                    }
                }
            }
            
            console.log('✅ All required fields are valid');
            return true;
        }
        
        function fallbackValidatePhysicianId(field) {
            const value = field.value.trim();
            
            if (!value) {
                return false;
            }
            
            const numValue = parseInt(value);
            
            if (isNaN(numValue) || numValue <= 0) {
                return false;
            }
            
            return true;
        }
        
        function fallbackUpdateStepIndicator(currentStep) {
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, index) => {
                step.classList.remove('active', 'completed', 'inactive');
                
                if (index + 1 < currentStep) {
                    step.classList.add('completed');
                } else if (index + 1 === currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.add('inactive');
                }
            });
        }
        
        function fallbackShowStep(stepNumber) {
            console.log('👁️ fallbackShowStep called for step:', stepNumber);
            
            // Hide all steps
            for (let i = 1; i <= 4; i++) {
                const stepElement = document.getElementById(`step${i}`);
                if (stepElement) {
                    stepElement.classList.add('hidden');
                }
            }
            
            // Show current step
            const currentStepElement = document.getElementById(`step${stepNumber}`);
            if (currentStepElement) {
                currentStepElement.classList.remove('hidden');
                console.log(`✅ Showing step ${stepNumber}`);
            }
            
            // Update navigation buttons
            fallbackUpdateNavigationButtons(stepNumber);
        }
        
        function fallbackUpdateNavigationButtons(currentStep) {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            
            if (prevBtn) {
                if (currentStep > 1) {
                    prevBtn.style.display = 'inline-flex';
                } else {
                    prevBtn.style.display = 'none';
                }
            }
            
            if (nextBtn && submitBtn) {
                if (currentStep < 4) {
                    nextBtn.classList.remove('hidden');
                    submitBtn.classList.add('hidden');
                } else {
                    nextBtn.classList.add('hidden');
                    submitBtn.classList.remove('hidden');
                }
            }
        }
        
        console.log('✅ Fallback functions defined');
        
        // NOW check and assign functions
        // Ensure showAddPatientForm is available even if main.js fails
        if (typeof window.showAddPatientForm !== 'function') {
            console.warn('⚠️ showAddPatientForm not available from main.js, creating fallback');
            window.showAddPatientForm = function() {
                console.log('📝 showAddPatientForm called (fallback version)');
                
                const defaultContent = document.getElementById('defaultContent');
                const patientForm = document.getElementById('patientForm');
                
                if (defaultContent) {
                    defaultContent.classList.add('hidden');
                    console.log('✅ Hidden default content');
                }
                
                if (patientForm) {
                    patientForm.classList.remove('hidden');
                    console.log('✅ Showed patient form');
                    
                    // Set global variables
                    window.currentStep = 1;
                    window.totalSteps = 4;
                    console.log('✅ Global variables set in fallback showAddPatientForm');
                    
                    // Also populate birth year dropdown in fallback
                    if (typeof window.populateBirthYearDropdown === 'function') {
                        window.populateBirthYearDropdown();
                    } else {
                        // Create a simple fallback population
                        populateBirthYearFallback();
                    }
                    
                    // Initialize form to step 1
                    fallbackShowStep(1);
                } else {
                    alert('Patient form element not found. Please refresh the page.');
                }
            };
            console.log('✅ Fallback showAddPatientForm created');
        } else {
            console.log('✅ showAddPatientForm available from main.js');
        }
        
        // Fallback function to populate birth year dropdown
        function populateBirthYearFallback() {
            console.log('🔄 populateBirthYearFallback called');
            const birthYearSelect = document.getElementById('patientAge');
            if (!birthYearSelect) {
                console.error('❌ patientAge element not found in fallback');
                return;
            }
            
            // Clear existing options except the first one
            birthYearSelect.innerHTML = '<option value="">Select Birth Year</option>';
            
            // Generate years from 1924 to current year
            const currentYear = new Date().getFullYear();
            const startYear = currentYear - 100;
            
            for (let year = currentYear; year >= startYear; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                birthYearSelect.appendChild(option);
            }
            
            console.log(`✅ Birth year dropdown populated with fallback function (${birthYearSelect.options.length} options)`);
        }
        
        // Ensure navigation functions are available
        if (typeof window.nextStep !== 'function') {
            console.warn('⚠️ nextStep not available from main.js, creating fallback');
            window.nextStep = function() {
                console.log('🔄 nextStep called (fallback version)');
                fallbackNextStep();
            };
            console.log('✅ Fallback nextStep created');
        } else {
            console.log('✅ nextStep available from main.js');
        }
        
        if (typeof window.previousStep !== 'function') {
            console.warn('⚠️ previousStep not available from main.js, creating fallback');
            window.previousStep = function() {
                console.log('🔄 previousStep called (fallback version)');
                fallbackPreviousStep();
            };
            console.log('✅ Fallback previousStep created');
        } else {
            console.log('✅ previousStep available from main.js');
        }
        
        // Ensure submitPatientForm is available
        if (typeof window.submitPatientForm !== 'function') {
            console.warn('⚠️ submitPatientForm not available from main.js, creating fallback');
            window.submitPatientForm = async function() {
                console.log('💾 submitPatientForm called (fallback version)');
                await fallbackSubmitPatientForm();
            };
            console.log('✅ Fallback submitPatientForm created');
        } else {
            console.log('✅ submitPatientForm available from main.js');
        }
        
        // Fallback submit patient form function
        async function fallbackSubmitPatientForm() {
            console.log('💾 fallbackSubmitPatientForm called');
            
            try {
                // Collect form data
                const formData = fallbackCollectFormData();
                console.log('📋 Form data collected:', formData);
                
                if (!formData) {
                    alert('Failed to collect form data');
                    return;
                }
                
                // Validate form data
                if (!fallbackValidateFormData(formData)) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                console.log('✅ Form data validated, submitting to API...');
                
                // Submit to API
                const response = await fetch('http://localhost:8000/patients', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to create patient: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('✅ Patient created:', result);
                
                alert(`Patient "${formData.patient_name}" saved successfully!`);
                
                // Refresh patient list
                if (typeof window.refreshPatientData === 'function') {
                    await window.refreshPatientData();
                } else {
                    await fallbackRefreshPatientData();
                }
                
                // Hide form and show patient list
                fallbackHideAddPatientForm();
                
            } catch (error) {
                console.error('❌ Failed to submit patient form:', error);
                alert('Failed to save patient. Please try again.');
            }
        }
        
        // Fallback collect form data function
        function fallbackCollectFormData() {
            console.log('📋 fallbackCollectFormData called');
            
            // Collect basic information
            const birthYear = parseInt(document.getElementById('patientAge')?.value);
            const currentYear = new Date().getFullYear();
            const calculatedAge = birthYear ? currentYear - birthYear : 0;
            
            const basicInfo = {
                patient_name: document.getElementById('patientName')?.value || '',
                patient_age: calculatedAge,
                birth_year: birthYear || 0,
                patient_gender: document.getElementById('patientGender')?.value || '',
                physician_id: parseInt(document.getElementById('physicianId')?.value) || 0,
                diagnosis_date: document.getElementById('diagnosisDate')?.value || '',
                symptom_onset_date: document.getElementById('symptomOnsetDate')?.value || null
            };
            
            // Collect medical history
            const medicalHistory = {
                location_type: document.getElementById('locationType')?.value || '',
                insurance_type: document.getElementById('insuranceType')?.value || '',
                contraindication_level: document.getElementById('contraindicationLevel')?.value || '',
                additional_notes: document.getElementById('additionalNotes')?.value || ''
            };
            
            // Collect symptoms and comorbidities
            const symptoms = [];
            const comorbidities = [];
            
            // Get checked symptoms from step 3
            const step3 = document.getElementById('step3');
            if (step3) {
                const formGroups = step3.querySelectorAll('.form-group');
                
                // First form-group contains symptoms
                if (formGroups[0]) {
                    const symptomCheckboxes = formGroups[0].querySelectorAll('input[type="checkbox"]:checked');
                    symptomCheckboxes.forEach(checkbox => {
                        symptoms.push(checkbox.value);
                    });
                }
                
                // Second form-group contains comorbidities
                if (formGroups[1]) {
                    const comorbidityCheckboxes = formGroups[1].querySelectorAll('input[type="checkbox"]:checked');
                    comorbidityCheckboxes.forEach(checkbox => {
                        comorbidities.push(checkbox.value);
                    });
                }
            }
            
            // Combine all data
            const formData = {
                ...basicInfo,
                ...medicalHistory,
                comorbidities: comorbidities,
                symptoms: symptoms
            };
            
            console.log('✅ Form data collected:', formData);
            return formData;
        }
        
        // Fallback validate form data function
        function fallbackValidateFormData(data) {
            console.log('🔍 fallbackValidateFormData called');
            
            if (!data.patient_name || !data.patient_name.trim()) {
                console.log('❌ Patient name is required');
                return false;
            }
            
            if (!data.patient_age || data.patient_age <= 0) {
                console.log('❌ Patient age is required and must be greater than 0');
                return false;
            }
            
            if (!data.patient_gender || !data.patient_gender.trim()) {
                console.log('❌ Patient gender is required');
                return false;
            }
            
            if (!data.physician_id || data.physician_id <= 0) {
                console.log('❌ Physician ID is required and must be greater than 0');
                return false;
            }
            
            if (!data.diagnosis_date || !data.diagnosis_date.trim()) {
                console.log('❌ Diagnosis date is required');
                return false;
            }
            
            if (!data.location_type || !data.location_type.trim()) {
                console.log('❌ Location type is required');
                return false;
            }
            
            if (!data.insurance_type || !data.insurance_type.trim()) {
                console.log('❌ Insurance type is required');
                return false;
            }
            
            if (!data.contraindication_level || !data.contraindication_level.trim()) {
                console.log('❌ Contraindication level is required');
                return false;
            }
            
            console.log('✅ All required fields are valid');
            return true;
        }
        
        // Fallback refresh patient data function
        async function fallbackRefreshPatientData() {
            console.log('🔄 fallbackRefreshPatientData called');
            
            try {
                const response = await fetch('http://localhost:8000/patients');
                if (!response.ok) {
                    throw new Error(`Failed to load patients: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('📊 Loaded patient data:', data);
                
                // Store patient data globally
                window.patientData = data.patients || [];
                
                // Update patient list display
                fallbackLoadPatientList();
                
                console.log('✅ Patient list refreshed');
            } catch (error) {
                console.error('❌ Failed to refresh patient data:', error);
            }
        }
        
        // Fallback load patient list function
        function fallbackLoadPatientList() {
            console.log('📋 fallbackLoadPatientList called');
            
            const patientList = document.getElementById('patientList');
            if (!patientList) {
                console.error('❌ Patient list element not found');
                return;
            }
            
            const patients = window.patientData || [];
            console.log('📊 Loading patients:', patients.length);
            
            // Sort patients: Drug A recommended patients first, then by name
            const sortedPatients = [...patients].sort((a, b) => {
                const aRecommended = a.drugAEligible || false;
                const bRecommended = b.drugAEligible || false;
                
                // First priority: Drug A recommended patients
                if (aRecommended && !bRecommended) return -1;
                if (!aRecommended && bRecommended) return 1;
                
                // Second priority: Patients with alerts
                const aHasAlert = a.hasAlert || a.has_alert || false;
                const bHasAlert = b.hasAlert || b.has_alert || false;
                if (aHasAlert && !bHasAlert) return -1;
                if (!aHasAlert && bHasAlert) return 1;
                
                // Third priority: Sort by name alphabetically
                const aName = (a.name || a.patient_name || '').toLowerCase();
                const bName = (b.name || b.patient_name || '').toLowerCase();
                return aName.localeCompare(bName);
            });
            
            console.log(`📋 Sorted patients: ${sortedPatients.filter(p => p.drugAEligible).length} recommended, ${sortedPatients.filter(p => p.hasAlert || p.has_alert).length} with alerts`);
            
            if (sortedPatients.length === 0) {
                patientList.innerHTML = `
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-users mb-2" style="font-size: 2rem; opacity: 0.5;"></i>
                        <p>No patients found</p>
                        <p style="font-size: 0.875rem;">Click "Add Patient" to get started</p>
                    </div>
                `;
                return;
            }
            
            patientList.innerHTML = sortedPatients.map((patient, index) => {
                const patientJson = JSON.stringify(patient).replace(/"/g, '&quot;');
                return `
                    <div class="patient-item" data-patient-index="${index}" onclick="window.selectPatient ? selectPatient(${patientJson}) : fallbackSelectPatient(${patientJson})">
                        <div class="patient-name">${escapeHtml(patient.name || patient.patient_name || 'Unknown Patient')}</div>
                        <div class="patient-info">
                            <span>Age: ${patient.age || patient.patient_age || 'N/A'}</span>
                            <span>Gender: ${patient.gender || patient.patient_gender || 'N/A'}</span>
                            <span>Physician: ${patient.physician?.id || patient.physician_id || 'N/A'}</span>
                        </div>
                        <div class="patient-status">
                            ${patient.hasAlert || patient.has_alert ? '<span class="status-badge alert">⚠️ Alert</span>' : ''}
                            ${patient.drugAEligible ? '<span class="status-badge recommend">✅ Recommend Drug A</span>' : '<span class="status-badge no-recommendation">ℹ️ No Drug A Recommendation</span>'}
                        </div>
                    </div>
                `;
            }).join('');
            
            console.log('✅ Patient list loaded');
        }
        
        // Fallback hide add patient form function
        function fallbackHideAddPatientForm() {
            console.log('🙈 fallbackHideAddPatientForm called');
            
            const patientForm = document.getElementById('patientForm');
            if (patientForm) {
                patientForm.classList.add('hidden');
            }
            
            const defaultContent = document.getElementById('defaultContent');
            if (defaultContent) {
                defaultContent.classList.remove('hidden');
            }
            
            // Reset form state
            window.currentStep = 1;
            fallbackClearFormData();
        }
        
        // Fallback clear form data function
        function fallbackClearFormData() {
            const form = document.getElementById('patientForm');
            if (form) {
                const inputs = form.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
            }
        }
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Fallback select patient function
        window.fallbackSelectPatient = function(patient) {
            console.log('👤 fallbackSelectPatient called:', patient);
            window.currentPatient = patient;
            
            // Update patient info display
            fallbackUpdatePatientInfo(patient);
            
            // Show alert panel if applicable
            if (patient.hasAlert || patient.has_alert) {
                const alertPanel = document.getElementById('alertPanel');
                if (alertPanel) {
                    alertPanel.classList.remove('hidden');
                }
            }
        };
        
        // Fallback update patient info function
        function fallbackUpdatePatientInfo(patient) {
            console.log('📋 fallbackUpdatePatientInfo called');
            
            const nameElement = document.getElementById('currentPatientName');
            const detailsElement = document.getElementById('currentPatientDetails');
            
            if (nameElement) {
                nameElement.textContent = patient.name || patient.patient_name || 'Unknown Patient';
            }
            
            if (detailsElement) {
                const age = patient.age || patient.patient_age || 'N/A';
                const gender = patient.gender || patient.patient_gender || 'N/A';
                const physicianId = patient.physician?.id || patient.physician_id || 'N/A';
                const diagnosisDate = patient.diagnosisDate || patient.diagnosis_date || 'N/A';
                
                const details = [
                    `Age: ${age}`,
                    `Gender: ${gender}`,
                    `Physician: ${physicianId}`,
                    `Diagnosis: ${diagnosisDate}`
                ].join(' • ');
                detailsElement.textContent = details;
            }
            
            // Update alert panel with patient information (without prediction results)
            // Prediction results will be shown after running AI analysis
            
            console.log('✅ Patient info updated (fallback)');
        }
        
        // Ensure selectPatient is available
        if (typeof window.selectPatient !== 'function') {
            console.warn('⚠️ selectPatient not available from main.js, using fallback');
            window.selectPatient = window.fallbackSelectPatient;
        }
        
        // Ensure refreshPatientData is available
        if (typeof window.refreshPatientData !== 'function') {
            console.warn('⚠️ refreshPatientData not available from main.js, creating fallback');
            window.refreshPatientData = async function() {
                console.log('🔄 refreshPatientData called (fallback version)');
                
                try {
                    // Load patient data from API
                    await fallbackRefreshPatientData();
                    
                    alert('Patient data refreshed successfully!');
                } catch (error) {
                    console.error('❌ Failed to refresh patient data:', error);
                    alert('Failed to refresh patient data. Please try again.');
                }
            };
            console.log('✅ Fallback refreshPatientData created');
        }
        
        // Fallback convert patient to API format
        function fallbackConvertPatientToAPIFormat(patient) {
            console.log('🔄 Converting patient data to API format (fallback):', patient);
            
            const currentYear = new Date().getFullYear();
            const birthYear = patient.birth_year || (currentYear - (patient.age || patient.patient_age || 0));
            const diagnosisDate = patient.diagnosisDate || patient.diagnosis_date || new Date().toISOString();
            
            const symptoms = patient.symptoms || [];
            const comorbidities = patient.comorbidities || [];
            const transactions = [];
            
            comorbidities.forEach(comorbidity => {
                transactions.push({
                    txn_dt: diagnosisDate,
                    physician_id: patient.physician?.id || patient.physician_id || null,
                    txn_location_type: patient.locationType || patient.location_type || 'OFFICE',
                    insurance_type: patient.insuranceType || patient.insurance_type || 'COMMERCIAL',
                    txn_type: 'CONDITIONS',
                    txn_desc: comorbidity
                });
            });
            
            symptoms.forEach(symptom => {
                transactions.push({
                    txn_dt: diagnosisDate,
                    physician_id: patient.physician?.id || patient.physician_id || null,
                    txn_location_type: patient.locationType || patient.location_type || 'OFFICE',
                    insurance_type: patient.insuranceType || patient.insurance_type || 'COMMERCIAL',
                    txn_type: 'SYMPTOMS',
                    txn_desc: symptom
                });
            });
            
            if (transactions.length === 0 || !transactions.some(t => t.txn_type === 'CONDITIONS')) {
                transactions.push({
                    txn_dt: diagnosisDate,
                    physician_id: patient.physician?.id || patient.physician_id || null,
                    txn_location_type: patient.locationType || patient.location_type || 'OFFICE',
                    insurance_type: patient.insuranceType || patient.insurance_type || 'COMMERCIAL',
                    txn_type: 'CONDITIONS',
                    txn_desc: 'DISEASE_X'
                });
            }
            
            return {
                patient_id: patient.id || patient.rawPatientId || 999,
                birth_year: birthYear,
                gender: (patient.gender || patient.patient_gender || 'M') === 'Male' ? 'M' : 'F',
                diagnosis_date: diagnosisDate,
                transactions: transactions,
                physician_info: {
                    physician_id: patient.physician?.id || patient.physician_id || null,
                    state: 'CA',
                    physician_type: patient.physician?.specialty || 'Internal Medicine',
                    gender: 'M',
                    birth_year: null
                }
            };
        }
        
        // Ensure analyzePatient is available
        if (typeof window.analyzePatient !== 'function') {
            console.warn('⚠️ analyzePatient not available from main.js, creating fallback');
            window.analyzePatient = async function() {
                console.log('🧠 analyzePatient called (fallback version)');
                
                if (!window.currentPatient) {
                    alert('Please select a patient first');
                    return;
                }
                
                const analyzeBtn = document.getElementById('analyzeBtn');
                if (analyzeBtn) {
                    analyzeBtn.disabled = true;
                    analyzeBtn.innerHTML = '<span class="loading">Analyzing...</span>';
                }
                
                try {
                    const apiRequest = fallbackConvertPatientToAPIFormat(window.currentPatient);
                    console.log('📤 Sending prediction request (fallback):', apiRequest);
                    
                    const response = await fetch('http://localhost:8000/predict', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(apiRequest)
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('❌ API Error:', errorText);
                        throw new Error(`Analysis failed: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('🧠 AI Analysis result:', result);
                    
                    // Update UI with analysis results
                    fallbackUpdateAnalysisResults(result);
                    
                    alert('AI analysis completed successfully!');
                    
                } catch (error) {
                    console.error('❌ AI Analysis failed:', error);
                    alert(`AI analysis failed: ${error.message}`);
                } finally {
                    if (analyzeBtn) {
                        analyzeBtn.disabled = false;
                        analyzeBtn.innerHTML = '<i class="fas fa-brain"></i> AI Analysis';
                    }
                }
            };
            console.log('✅ Fallback analyzePatient created');
        }
        
        // Fallback update analysis results function
        function fallbackUpdateAnalysisResults(result) {
            console.log('📊 fallbackUpdateAnalysisResults called:', result);
            
            // Update patient object with analysis results for internal tracking
            if (window.currentPatient) {
                window.currentPatient.riskScore = result.probability;
                window.currentPatient.hasAlert = result.alert_recommended || result.probability > 0.7;
                window.currentPatient.prediction = result.prediction;
            }
            
            // Show alert panel - removed color coding for neutral design
            const alertPanel = document.getElementById('alertPanel');
            if (alertPanel) {
                alertPanel.classList.remove('hidden');
            }
            
            // Update alert panel with detailed patient information and prediction
            // Use the optimized function from main.js
            if (typeof updateAlertPanelPatientInfo === 'function') {
                updateAlertPanelPatientInfo(window.currentPatient, result);
            } else {
                console.warn('updateAlertPanelPatientInfo not available, using fallback');
                fallbackUpdateAlertPanelPatientInfo(window.currentPatient, result);
            }
            
            // ===== NEW: Initialize Clinical Decision Support Components =====
            if (window.clinicalDS && result.clinical_eligibility) {
                console.log('🏥 Initializing Clinical Decision Support components...');
                
                try {
                    // Initialize the clinical decision support system with patient and prediction data
                    window.clinicalDS.initialize(window.currentPatient, result);
                    
                    // Show the clinical decision support container
                    const cdsContainer = document.getElementById('clinicalDecisionSupportContainer');
                    if (cdsContainer) {
                        cdsContainer.classList.remove('hidden');
                        
                        // Render components into their containers
                        const eligibilityContainer = document.getElementById('clinicalEligibilityCardContainer');
                        if (eligibilityContainer) {
                            eligibilityContainer.innerHTML = window.clinicalDS.renderClinicalEligibilityCard();
                        }
                        
                        const visualizationContainer = document.getElementById('riskVisualizationContainer');
                        if (visualizationContainer) {
                            visualizationContainer.innerHTML = window.clinicalDS.renderRiskFactorVisualization();
                        }
                        
                        const flowContainer = document.getElementById('decisionSupportFlowContainer');
                        if (flowContainer) {
                            flowContainer.innerHTML = window.clinicalDS.renderDecisionSupportFlow();
                        }
                        
                        console.log('✅ Clinical Decision Support components rendered successfully');
                    }
                } catch (error) {
                    console.error('❌ Failed to initialize Clinical Decision Support:', error);
                }
            } else {
                console.log('ℹ️ Clinical Decision Support not available or clinical_eligibility data missing');
            }
            // ===== END NEW CODE =====
            
            console.log('✅ Analysis results updated (fallback)');
            console.log('   Prediction:', result.prediction === 1 ? 'Likely to prescribe' : 'Unlikely to prescribe');
            console.log('   Probability (Confidence):', (result.probability * 100).toFixed(1) + '%');
            console.log('   Alert Recommended:', result.alert_recommended);
        }
        
        // Fallback function to update alert panel patient info
        function fallbackUpdateAlertPanelPatientInfo(patient, result) {
            if (!patient) return;
            
            const alertPatientName = document.getElementById('alertPatientName');
            const alertPatientDetails = document.getElementById('alertPatientDetails');
            
            if (alertPatientName) {
                const patientName = patient.name || patient.patient_name || 'Patient';
                alertPatientName.textContent = `${patientName} - Drug A Prescription Alert`;
            }
            
            if (alertPatientDetails) {
                // Extract patient information
                const age = patient.age || patient.patient_age || 'Unknown';
                const gender = patient.gender || patient.patient_gender || 'Unknown';
                const diagnosisDate = patient.diagnosisDate || patient.diagnosis_date || 'Unknown';
                const physicianId = patient.physician?.id || patient.physician_id || 'Unknown';
                
                // Medical History
                const locationType = patient.locationType || patient.location_type || 'Unknown';
                const insuranceType = patient.insuranceType || patient.insurance_type || 'Unknown';
                const contraindicationLevel = patient.contraindicationLevel || patient.contraindication_level || 'Unknown';
                
                // Symptoms and Comorbidities
                const symptoms = patient.symptoms || [];
                const comorbidities = patient.comorbidities || [];
                
                let detailsHTML = '';
                
                // Add AI Prediction Section - only if result exists
                if (result) {
                    const prediction = result.prediction;
                    const probability = result.probability || 0;
                    
                    // Determine prediction text and icon
                    // not_prescribed_drug_a = 1: Patient was not prescribed Drug A (potential missed prescription)
                    // not_prescribed_drug_a = 0: Patient received appropriate treatment
                    let predictionText, predictionIcon, predictionColor;
                    if (prediction === 1) {
                        predictionText = 'Your patient meets the eligibility criteria for antiviral drug Drug A but has not yet been prescribed it. Please evaluate whether treatment should be initiated.';
                        predictionIcon = 'fa-exclamation-triangle';
                        predictionColor = '#f59e0b';
                    } else {
                        predictionText = 'Treatment Appears Appropriate';
                        predictionIcon = 'fa-check-circle';
                        predictionColor = '#10b981';
                    }
                    
                    // Determine confidence level
                    let confidenceLevel, confidenceBadgeClass, confidenceBarColor;
                    if (probability > 0.8) {
                        confidenceLevel = 'High Confidence';
                        confidenceBadgeClass = 'confidence-high';
                        confidenceBarColor = prediction === 1 ? '#10b981' : '#3b82f6';
                    } else if (probability > 0.6) {
                        confidenceLevel = 'Moderate Confidence';
                        confidenceBadgeClass = 'confidence-moderate';
                        confidenceBarColor = prediction === 1 ? '#84cc16' : '#60a5fa';
                    } else {
                        confidenceLevel = 'Low Confidence';
                        confidenceBadgeClass = 'confidence-low';
                        confidenceBarColor = '#f59e0b';
                    }
                    
                    // Get interpretation text - not_prescribed_drug_a indicates missed prescription opportunity
                    let interpretationText = '';
                    if (prediction === 1) {
                        // not_prescribed_drug_a = 1 means patient was NOT prescribed Drug A (missed prescription)
                        if (probability > 0.8) {
                            interpretationText = `The AI model is <strong>highly confident (${(probability * 100).toFixed(1)}%)</strong> that this patient has not been prescribed Drug A, suggesting a <strong>potential missed opportunity for treatment</strong>.<br><br>Please review the patient's eligibility and consider initiating Drug A therapy if clinically appropriate.`;
                        } else if (probability > 0.6) {
                            interpretationText = `The AI model has <strong>moderate confidence (${(probability * 100).toFixed(1)}%)</strong> that this patient may not have received Drug A. Consider reviewing patient factors and treatment options.`;
                        } else {
                            interpretationText = `The AI model has <strong>low confidence (${(probability * 100).toFixed(1)}%)</strong> in this prediction. This case may have mixed indicators. Clinical judgment is essential.`;
                        }
                    } else {
                        // not_prescribed_drug_a = 0 means patient likely received appropriate treatment
                        if (probability > 0.8) {
                            interpretationText = `The AI model is <strong>highly confident (${(probability * 100).toFixed(1)}%)</strong> that this patient has received appropriate treatment. Drug A prescription appears aligned with clinical patterns.`;
                        } else if (probability > 0.6) {
                            interpretationText = `The AI model has <strong>moderate confidence (${(probability * 100).toFixed(1)}%)</strong> that treatment is appropriate. Continue monitoring patient response.`;
                        } else {
                            interpretationText = `The AI model has <strong>low confidence (${(probability * 100).toFixed(1)}%)</strong> in this prediction. This is an atypical case requiring careful clinical assessment.`;
                        }
                    }
                    
                    detailsHTML += `
                        <div class="prediction-section" style="margin-bottom: 1.5rem;">
                            <div class="prediction-result" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: ${prediction === 1 ? '#f0fdf4' : '#eff6ff'}; border-radius: 8px; margin-bottom: 1rem;">
                                <i class="fas ${predictionIcon}" style="color: ${predictionColor}; font-size: 1.5rem;"></i>
                                <div style="flex: 1;">
                                    <div style="font-size: 0.75rem; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">AI Prediction</div>
                                    <div style="font-weight: 600; color: var(--gray-900); font-size: 1.1rem;">${predictionText}</div>
                                </div>
                            </div>
                            
                            <div class="confidence-section" style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600; color: var(--gray-700); font-size: 0.875rem;">Not Prescribed Drug-A Probability</span>
                                    <span class="confidence-badge ${confidenceBadgeClass}" style="padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 600;">${confidenceLevel}</span>
                                </div>
                                <div class="confidence-bar" style="position: relative; height: 32px; background: #f3f4f6; border-radius: 16px; overflow: hidden;">
                                    <div class="confidence-fill" style="height: 100%; width: ${probability * 100}%; background: ${confidenceBarColor}; border-radius: 16px; transition: width 0.6s ease;"></div>
                                    <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-weight: 700; font-size: 0.875rem; color: #1f2937; z-index: 10;">${(probability * 100).toFixed(1)}%</span>
                                </div>
                            </div>
                            
                            <div class="interpretation" style="padding: 1rem; background: #f9fafb; border-radius: 6px; line-height: 1.6; color: #4b5563; font-size: 0.9rem; margin-bottom: 1rem;">
                                ${interpretationText}
                            </div>
                        </div>`;
                }
                
                // Patient Details Section
                detailsHTML += `
                    <div style="display: grid; gap: 1rem; line-height: 1.5;">
                        <!-- Patient Information Section -->
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 1rem 0; font-size: 1.1rem; font-weight: 700; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-user" style="color: #3b82f6;"></i>
                                Patient Information
                            </h4>
                            
                            <!-- Demographics Summary -->
                            <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; padding: 0.75rem; background: var(--gray-50); border-radius: 6px;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-user-circle" style="color: var(--gray-500);"></i>
                                <span><strong>${age}</strong> years old, ${gender}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-user-md" style="color: var(--gray-500);"></i>
                                <span>Physician <strong>#${physicianId}</strong></span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-calendar-alt" style="color: var(--gray-500);"></i>
                                <span>Dx: <strong>${diagnosisDate}</strong></span>
                            </div>
                        </div>
                        
                        <!-- Medical Context -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                            <div style="padding: 0.5rem; border-left: 3px solid var(--primary); background: var(--gray-50); border-radius: 4px;">
                                <div style="font-size: 0.75rem; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px;">Location</div>
                                <div style="font-weight: 600; color: var(--gray-900); margin-top: 0.25rem;">${locationType}</div>
                            </div>
                            <div style="padding: 0.5rem; border-left: 3px solid var(--primary); background: var(--gray-50); border-radius: 4px;">
                                <div style="font-size: 0.75rem; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px;">Insurance</div>
                                <div style="font-weight: 600; color: var(--gray-900); margin-top: 0.25rem;">${insuranceType}</div>
                            </div>
                            <div style="padding: 0.5rem; border-left: 3px solid var(--primary); background: var(--gray-50); border-radius: 4px;">
                                <div style="font-size: 0.75rem; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px;">Contraindication</div>
                                <div style="font-weight: 600; color: var(--gray-900); margin-top: 0.25rem;">${contraindicationLevel}</div>
                            </div>
                        </div>
                    </div>`;
                
                // Add symptoms if available
                if (symptoms.length > 0) {
                    detailsHTML += `
                        <div style="padding: 0.75rem; background: #fffbeb; border-left: 3px solid #f59e0b; border-radius: 4px;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <i class="fas fa-stethoscope" style="color: #f59e0b;"></i>
                                <span style="font-weight: 600; color: var(--gray-900);">Symptoms</span>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${symptoms.map(s => `<span style="padding: 0.25rem 0.75rem; background: white; border: 1px solid #fde68a; border-radius: 12px; font-size: 0.875rem; color: var(--gray-700);">${s}</span>`).join('')}
                            </div>
                        </div>`;
                }
                
                // Add comorbidities if available
                if (comorbidities.length > 0) {
                    detailsHTML += `
                        <div style="padding: 0.75rem; background: #fef2f2; border-left: 3px solid #ef4444; border-radius: 4px;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <i class="fas fa-heartbeat" style="color: #ef4444;"></i>
                                <span style="font-weight: 600; color: var(--gray-900);">Comorbidities</span>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${comorbidities.map(c => `<span style="padding: 0.25rem 0.75rem; background: white; border: 1px solid #fecaca; border-radius: 12px; font-size: 0.875rem; color: var(--gray-700);">${c}</span>`).join('')}
                            </div>
                        </div>`;
                }
                
                detailsHTML += `</div>`;
                
                alertPatientDetails.innerHTML = detailsHTML;
            }
        }
        
        // Debug: Check birth year dropdown
        setTimeout(() => {
            console.log('🔍 Debug: Checking birth year dropdown...');
            const birthYearSelect = document.getElementById('patientAge');
            if (birthYearSelect) {
                console.log('✅ Birth year select element found');
                console.log('Options count:', birthYearSelect.options.length);
                console.log('Current value:', birthYearSelect.value);
                console.log('Element disabled:', birthYearSelect.disabled);
                console.log('Element readonly:', birthYearSelect.readOnly);
                console.log('Element style:', birthYearSelect.style.cssText);
                
                // Log all options
                for (let i = 0; i < birthYearSelect.options.length; i++) {
                    console.log(`Option ${i}: value="${birthYearSelect.options[i].value}", text="${birthYearSelect.options[i].textContent}"`);
                }
            } else {
                console.error('❌ Birth year select element not found');
            }
            
            // Force populate if not populated
            if (birthYearSelect && birthYearSelect.options.length <= 1) {
                console.log('⚠️ Birth year dropdown not populated, forcing population...');
                if (typeof window.populateBirthYearDropdown === 'function') {
                    window.populateBirthYearDropdown();
                    // Check again after population
                    setTimeout(() => {
                        console.log('🔄 After forced population - Options count:', birthYearSelect.options.length);
                    }, 100);
                } else {
                    console.error('❌ populateBirthYearDropdown function not available');
                }
            }
        }, 1000);
        
        // Additional debug: Check if form elements exist
        setTimeout(() => {
            console.log('🔍 Debug: Checking form elements...');
            const formElements = [
                'patientName', 'patientAge', 'patientGender', 'physicianId', 
                'diagnosisDate', 'locationType', 'insuranceType', 'contraindicationLevel'
            ];
            
            formElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    console.log(`✅ Found element: ${elementId} (${element.tagName})`);
                    
                    // Special debug for Physician ID
                    if (elementId === 'physicianId') {
                        console.log(`🔍 Physician ID details:`);
                        console.log(`  - Type: ${element.type}`);
                        console.log(`  - Min: ${element.min}`);
                        console.log(`  - Step: ${element.step}`);
                        console.log(`  - Required: ${element.required}`);
                        console.log(`  - Disabled: ${element.disabled}`);
                        console.log(`  - ReadOnly: ${element.readOnly}`);
                        console.log(`  - Placeholder: "${element.placeholder}"`);
                        console.log(`  - Current value: "${element.value}"`);
                        
                        // Test if element can accept input
                        element.addEventListener('focus', function() {
                            console.log('🔍 Physician ID field focused - ready for input');
                        });
                        
                        element.addEventListener('input', function(e) {
                            console.log('🔍 Physician ID input detected:', e.target.value);
                        });
                    }
                } else {
                    console.error(`❌ Missing element: ${elementId}`);
                }
            });
            
            // Check step elements
            for (let i = 1; i <= 4; i++) {
                const stepElement = document.getElementById(`step${i}`);
                if (stepElement) {
                    console.log(`✅ Found step element: step${i}`);
                } else {
                    console.error(`❌ Missing step element: step${i}`);
                }
            }
        }, 1500);
        
        // Immediate attempt to populate birth year dropdown
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM loaded, attempting to populate birth year dropdown...');
            
            // Set global variables
            window.currentStep = 1;
            window.totalSteps = 4;
            console.log('✅ Global variables set: currentStep=1, totalSteps=4');
            
            setTimeout(() => {
                if (typeof window.populateBirthYearDropdown === 'function') {
                    window.populateBirthYearDropdown();
                    console.log('✅ Birth year dropdown populated on DOM load');
                } else {
                    populateBirthYearFallback();
                    console.log('✅ Birth year dropdown populated with fallback on DOM load');
                }
            }, 100);
        });
        
        // Debug function to test step navigation
        window.debugStepNavigation = function() {
            console.log('🧪 Debug: Testing step navigation...');
            console.log('Current step:', window.currentStep || 'undefined');
            console.log('Total steps:', window.totalSteps || 'undefined');
            console.log('nextStep function available:', typeof window.nextStep === 'function');
            console.log('validateCurrentStep function available:', typeof window.validateCurrentStep === 'function');
            
            // Test validation
            if (typeof window.validateCurrentStep === 'function') {
                const result = window.validateCurrentStep();
                console.log('Validation test result:', result);
            }
            
            // Test next step
            if (typeof window.nextStep === 'function') {
                console.log('Calling nextStep()...');
                window.nextStep();
            }
        };
        
        // Make debug function available globally
        console.log('🔧 Debug function debugStepNavigation() available globally');
    </script>
</body>
</html>